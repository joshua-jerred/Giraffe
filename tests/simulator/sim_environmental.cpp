/**
 * =*========GIRAFFE========*=
 * A Unified Flight Command and Control System
 * https://github.com/joshua-jerred/Giraffe
 * https://giraffe.joshuajer.red/
 * =*=======================*=
 *
 * @file   sim_environmental.cpp
 * @brief  Implementation of the SimEnvironmental Simulation for the GFS
 * Simulator
 *
 * =*=======================*=
 * @author     Joshua Jerred (https://joshuajer.red)
 * @date       2024-02-13
 * @copyright  2024 (license to be defined)
 */

#include "sim_environmental.hpp"

#include <vector>

namespace gfs_sim {

static const std::vector<EnvData> K_ENVIRONMENTAL_DATA = {
    {0.0, -0.5, 972.0, 310.0, 4.115552, 77.0},
    {350.0, -0.5, 968.0, 313.0, 5.14444, 70.0},
    {588.0, 0.4, 940.0, 334.0, 12.346656, 55.0},
    {597.0, 0.4, 939.0, 335.0, 12.346656, 55.0},
    {719.0, -0.1, 925.0, 345.0, 13.375544, 55.0},
    {902.0, -1.3, 904.0, 345.0, 14.918876000000001, 58.0},
    {938.0, -1.5, 900.0, 344.0, 14.918876000000001, 59.0},
    {1197.0, -3.2, 871.0, 335.0, 13.375544, 56.0},
    {1298.0, -3.8, 860.0, 340.0, 12.346656, 54.0},
    {1344.0, -4.1, 855.0, 338.0, 12.346656, 54.0},
    {1390.0, -4.5, 850.0, 335.0, 11.832212, 54.0},
    {1399.0, -4.6, 849.0, 335.0, 11.832212, 54.0},
    {1502.0, -5.4, 838.0, 335.0, 12.8611, 56.0},
    {1558.0, -5.9, 832.0, 338.0, 12.346656, 58.0},
    {1605.0, -6.3, 827.0, 340.0, 12.346656, 58.0},
    {1624.0, -6.5, 825.0, 339.0, 12.346656, 58.0},
    {1720.0, -5.8, 815.0, 335.0, 12.8611, 42.0},
    {1768.0, -5.5, 810.0, 330.0, 12.8611, 35.0},
    {1816.0, -5.8, 805.0, 325.0, 12.346656, 33.0},
    {1826.0, -5.9, 804.0, 325.0, 12.346656, 32.0},
    {1914.0, -6.4, 795.0, 320.0, 14.404432, 34.0},
    {1963.0, -6.7, 790.0, 325.0, 14.918876000000001, 35.0},
    {2013.0, -6.8, 785.0, 330.0, 15.947764000000001, 32.0},
    {2103.0, -7.0, 776.0, 330.0, 16.976652, 27.0},
    {2163.0, -7.1, 770.0, 326.0, 16.976652, 24.0},
    {2317.0, -7.5, 755.0, 315.0, 16.976652, 18.0},
    {2431.0, -7.8, 744.0, 320.0, 15.43332, 14.0},
    {2452.0, -7.9, 742.0, 320.0, 15.947764000000001, 14.0},
    {2536.0, -7.4, 734.0, 320.0, 16.976652, 6.0},
    {2654.0, -6.6, 723.0, 320.0, 19.548872, 1.0},
    {2675.0, -6.5, 721.0, 319.0, 19.548872, 1.0},
    {2740.0, -6.7, 715.0, 318.0, 19.548872, 1.0},
    {2806.0, -6.5, 709.0, 316.0, 19.034428000000002, 1.0},
    {2850.0, -6.5, 705.0, 315.0, 19.034428000000002, 1.0},
    {2873.0, -6.5, 703.0, 315.0, 19.034428000000002, 1.0},
    {2906.0, -6.5, 700.0, 315.0, 18.519984, 1.0},
    {3062.0, -7.3, 686.0, 320.0, 17.491096, 1.0},
    {3176.0, -7.9, 676.0, 320.0, 18.00554, 1.0},
    {3268.0, -8.4, 668.0, 315.0, 18.519984, 1.0},
    {3361.0, -8.9, 660.0, 315.0, 19.548872, 1.0},
    {3467.0, -9.4, 651.0, 315.0, 18.00554, 1.0},
    {3563.0, -9.9, 643.0, 320.0, 20.57776, 1.0},
    {3684.0, -10.6, 633.0, 315.0, 21.092204, 2.0},
    {3708.0, -10.7, 631.0, 314.0, 21.092204, 2.0},
    {3891.0, -12.1, 616.0, 310.0, 20.063316, 4.0},
    {4003.0, -12.9, 607.0, 305.0, 21.606648, 6.0},
    {4091.0, -13.6, 600.0, 310.0, 22.121092, 9.0},
    {4193.0, -14.3, 592.0, 305.0, 21.606648, 15.0},
    {4401.0, -15.9, 576.0, 305.0, 20.063316, 35.0},
    {4493.0, -16.5, 569.0, 305.0, 19.548872, 34.0},
    {4598.0, -17.2, 561.0, 305.0, 18.00554, 32.0},
    {4692.0, -17.8, 554.0, 305.0, 19.034428000000002, 31.0},
    {4801.0, -18.5, 546.0, 300.0, 20.063316, 29.0},
    {4897.0, -19.1, 539.0, 300.0, 19.548872, 28.0},
    {4911.0, -19.2, 538.0, 300.0, 19.548872, 28.0},
    {5021.0, -20.2, 530.0, 300.0, 20.063316, 30.0},
    {5204.0, -21.8, 517.0, 300.0, 18.519984, 34.0},
    {5450.0, -23.9, 500.0, 295.0, 18.519984, 39.0},
    {5523.0, -24.5, 495.0, 291.0, 19.548872, 39.0},
    {5642.0, -25.5, 487.0, 285.0, 20.57776, 38.0},
    {5915.0, -27.7, 469.0, 281.0, 19.548872, 34.0},
    {5976.0, -28.3, 465.0, 280.0, 19.548872, 37.0},
    {6148.0, -29.9, 454.0, 282.0, 20.57776, 46.0},
    {6339.0, -31.4, 442.0, 285.0, 21.606648, 42.0},
    {6452.0, -32.3, 435.0, 285.0, 22.121092, 40.0},
    {6517.0, -32.8, 431.0, 285.0, 22.121092, 42.0},
    {6868.0, -35.5, 410.0, 282.0, 23.664424, 49.0},
    {7040.0, -36.7, 400.0, 280.0, 24.178868, 43.0},
    {7092.0, -37.1, 397.0, 279.0, 24.178868, 43.0},
    {7394.0, -38.9, 380.0, 275.0, 25.207756, 43.0},
    {7614.0, -40.3, 368.0, 275.0, 23.664424, 42.0},
    {7651.0, -40.6, 366.0, 275.0, 23.664424, 43.0},
    {7820.0, -42.0, 357.0, 270.0, 24.178868, 46.0},
    {7839.0, -42.1, 356.0, 271.0, 24.178868, 46.0},
    {7972.0, -42.9, 349.0, 275.0, 25.207756, 44.0},
    {8287.0, -44.9, 333.0, 270.0, 27.779976, 39.0},
    {8533.0, -46.4, 321.0, 270.0, 28.294420000000002, 36.0},
    {8575.0, -46.7, 319.0, 269.0, 27.779976, 35.0},
    {8679.0, -47.3, 314.0, 265.0, 27.265532, 38.0},
    {8743.0, -47.7, 311.0, 265.0, 27.265532, 39.0},
    {8828.0, -48.4, 307.0, 265.0, 27.779976, 36.0},
    {8893.0, -48.9, 304.0, 265.0, 28.808864, 34.0},
    {8980.0, -49.5, 300.0, 265.0, 29.837752000000002, 39.0},
    {9002.0, -49.6, 299.0, 265.0, 29.837752000000002, 38.0},
    {9380.0, -52.1, 282.0, 257.0, 28.808864, 33.0},
    {9471.0, -52.8, 278.0, 255.0, 28.808864, 33.0},
    {9564.0, -53.4, 274.0, 260.0, 29.323308, 32.0},
    {9658.0, -54.1, 270.0, 255.0, 30.352196, 32.0},
    {9682.0, -54.3, 269.0, 255.0, 30.86664, 32.0},
    {9705.0, -54.5, 268.0, 255.0, 30.86664, 32.0},
    {9777.0, -54.5, 265.0, 258.0, 31.895528000000002, 32.0},
    {9924.0, -53.2, 259.0, 265.0, 33.953304, 28.0},
    {10099.0, -51.7, 252.0, 260.0, 32.409972, 24.0},
    {10150.0, -51.3, 250.0, 265.0, 32.409972, 23.0},
    {10203.0, -50.8, 248.0, 265.0, 32.924416, 22.0},
    {10283.0, -50.1, 245.0, 265.0, 34.467748, 22.0},
    {10364.0, -49.4, 242.0, 260.0, 33.43886, 21.0},
    {10446.0, -48.6, 239.0, 260.0, 36.01108, 20.0},
    {10699.0, -46.3, 230.0, 266.0, 39.612188, 19.0},
    {10875.0, -46.0, 224.0, 270.0, 42.184408, 17.0},
    {10934.0, -45.9, 222.0, 270.0, 41.669964, 17.0},
    {10964.0, -45.9, 221.0, 270.0, 41.669964, 16.0},
    {11179.0, -46.1, 214.0, 266.0, 39.612188, 15.0},
    {11210.0, -46.1, 213.0, 265.0, 39.097744, 14.0},
    {11498.0, -45.7, 204.0, 260.0, 42.698852, 12.0},
    {11630.0, -45.5, 200.0, 260.0, 40.126632, 11.0},
    {11663.0, -45.6, 199.0, 260.0, 40.126632, 11.0},
    {12184.0, -46.7, 184.0, 265.0, 36.01108, 9.0},
    {12293.0, -46.9, 181.0, 261.0, 37.554412, 8.0},
    {12329.0, -46.9, 180.0, 260.0, 38.068856000000004, 8.0},
    {12366.0, -46.9, 179.0, 260.0, 38.068856000000004, 7.0},
    {12516.0, -46.9, 175.0, 262.0, 39.097744, 7.0},
    {12785.0, -47.8, 168.0, 265.0, 40.641076, 6.0},
    {12864.0, -48.0, 166.0, 265.0, 39.097744, 6.0},
    {13025.0, -48.5, 162.0, 261.0, 37.039968, 5.0},
    {13066.0, -48.6, 161.0, 260.0, 36.525524000000004, 5.0},
    {13315.0, -49.0, 155.0, 260.0, 41.15552, 5.0},
    {13400.0, -49.1, 153.0, 258.0, 42.698852, 4.0},
    {13443.0, -49.1, 152.0, 257.0, 43.213296, 4.0},
    {13530.0, -49.1, 150.0, 255.0, 44.756628, 4.0},
    {13663.0, -48.1, 147.0, 250.0, 45.271072000000004, 4.0},
    {13753.0, -47.5, 145.0, 255.0, 44.242184, 3.0},
    {14126.0, -49.1, 137.0, 260.0, 40.126632, 3.0},
    {14174.0, -49.3, 136.0, 260.0, 39.612188, 3.0},
    {14271.0, -49.6, 134.0, 260.0, 39.097744, 3.0},
    {14468.0, -50.3, 130.0, 260.0, 38.5833, 2.0},
    {14672.0, -50.9, 126.0, 260.0, 38.5833, 2.0},
    {14724.0, -51.1, 125.0, 260.0, 39.097744, 2.0},
    {14776.0, -51.1, 124.0, 260.0, 39.097744, 2.0},
    {14989.0, -51.9, 120.0, 260.0, 40.641076, 2.0},
    {15098.0, -52.3, 118.0, 260.0, 39.612188, 2.0},
    {15263.0, -52.8, 115.0, 260.0, 37.554412, 2.0},
    {15492.0, -53.5, 111.0, 260.0, 36.525524000000004, 1.0},
    {15550.0, -53.7, 110.0, 260.0, 36.01108, 1.0},
    {15608.0, -53.9, 109.0, 260.0, 34.467748, 1.0},
    {15727.0, -54.3, 107.0, 260.0, 34.982192, 1.0},
    {15848.0, -54.3, 105.0, 260.0, 35.496636, 1.0},
    {15909.0, -54.1, 104.0, 260.0, 36.525524000000004, 1.0},
    {15971.0, -54.1, 103.0, 260.0, 37.554412, 1.0},
    {16160.0, -54.7, 100.0, 265.0, 36.525524000000004, 1.0},
    {16289.0, -55.6, 98.0, 270.0, 34.467748, 1.0},
    {16487.0, -56.9, 95.0, 265.0, 31.895528000000002, 1.0},
    {16555.0, -57.1, 94.0, 263.0, 31.381084, 1.0},
    {16684.0, -56.9, 92.1, 258.0, 29.837752000000002, 1.0},
    {16761.0, -56.9, 91.0, 255.0, 28.808864, 1.0},
    {16880.0, -56.9, 89.3, 258.0, 29.837752000000002, 1.0},
    {16974.0, -56.8, 88.0, 260.0, 30.352196, 1.0},
    {17046.0, -56.6, 87.0, 265.0, 28.808864, 1.0},
    {17346.0, -56.2, 83.0, 250.0, 27.265532, 1.0},
    {17415.0, -56.1, 82.1, 250.0, 26.751088, 1.0},
    {17423.0, -56.1, 82.0, 250.0, 26.751088, 1.0},
    {17613.0, -55.7, 79.6, 250.0, 28.808864, 1.0},
    {17661.0, -55.6, 79.0, 250.0, 29.323308, 1.0},
    {17751.0, -55.5, 77.9, 253.0, 28.294420000000002, 1.0},
    {17992.0, -56.4, 75.0, 260.0, 24.693312, 1.0},
    {18163.0, -57.1, 73.0, 260.0, 25.207756, 1.0},
    {18340.0, -57.8, 71.0, 260.0, 25.7222, 1.0},
    {18430.0, -58.1, 70.0, 260.0, 26.751088, 1.0},
    {18630.0, -59.3, 67.8, 260.0, 28.808864, 1.0},
    {18695.0, -59.7, 67.1, 260.0, 29.837752000000002, 1.0},
    {18798.0, -59.5, 66.0, 260.0, 30.86664, 1.0},
    {18817.0, -59.5, 65.8, 261.0, 30.352196, 1.0},
    {18990.0, -58.9, 64.0, 266.0, 27.779976, 1.0},
    {19290.0, -59.3, 61.0, 275.0, 23.14998, 1.0},
    {19499.0, -59.5, 59.0, 275.0, 24.178868, 1.0},
    {19638.0, -59.7, 57.7, 277.0, 20.57776, 1.0},
    {19825.0, -59.4, 56.0, 280.0, 15.947764000000001, 1.0},
    {19881.0, -59.3, 55.5, 271.0, 14.918876000000001, 1.0},
    {19949.0, -59.1, 54.9, 261.0, 13.889988, 1.0},
    {20052.0, -59.6, 54.0, 245.0, 12.346656, 1.0},
    {20286.0, -60.6, 52.0, 225.0, 15.947764000000001, 1.0},
    {20530.0, -61.7, 50.0, 240.0, 19.548872, 2.0},
    {20769.0, -62.9, 48.1, 249.0, 20.57776, 2.0},
    {20782.0, -62.9, 48.0, 250.0, 20.57776, 2.0},
    {20898.0, -63.1, 47.1, 256.0, 20.063316, 2.0},
    {21179.0, -62.3, 45.0, 270.0, 19.034428000000002, 1.0},
    {21192.0, -62.3, 44.9, 271.0, 19.034428000000002, 1.0},
    {21474.0, -61.3, 42.9, 283.0, 13.375544, 1.0},
    {21754.0, -62.2, 41.0, 295.0, 8.231104, 2.0},
    {21860.0, -62.5, 40.3, 281.0, 8.231104, 2.0},
    {21906.0, -62.6, 40.0, 275.0, 8.231104, 2.0},
    {21999.0, -62.7, 39.4, 266.0, 8.745548, 2.0},
    {22062.0, -62.5, 39.0, 260.0, 9.259992, 2.0},
    {22222.0, -62.1, 38.0, 270.0, 10.803324, 2.0},
    {22387.0, -61.9, 37.0, 275.0, 9.774436, 2.0},
    {22420.0, -61.9, 36.8, 273.0, 9.774436, 2.0},
    {22730.0, -62.4, 35.0, 250.0, 11.317768000000001, 2.0},
    {22801.0, -62.5, 34.6, 259.0, 11.317768000000001, 2.0},
    {23018.0, -62.3, 33.4, 286.0, 11.832212, 2.0},
    {23092.0, -62.4, 33.0, 295.0, 11.832212, 2.0},
    {23225.0, -62.5, 32.3, 288.0, 10.28888, 2.0},
    {23379.0, -62.7, 31.5, 280.0, 8.231104, 2.0},
    {23478.0, -62.4, 31.0, 275.0, 6.687772, 2.0},
    {23680.0, -61.7, 30.0, 275.0, 9.259992, 2.0},
    {23806.0, -60.9, 29.4, 290.0, 10.28888, 2.0},
    {23891.0, -60.6, 29.0, 300.0, 10.803324, 2.0},
    {24088.0, -59.9, 28.1, 304.0, 11.832212, 2.0},
    {24110.0, -60.0, 28.0, 305.0, 11.832212, 2.0},
    {24337.0, -60.5, 27.0, 310.0, 10.803324, 2.0},
    {24573.0, -61.2, 26.0, 275.0, 6.687772, 2.0},
    {24621.0, -61.3, 25.8, 275.0, 7.202216, 2.0},
    {24817.0, -61.1, 25.0, 275.0, 8.231104, 2.0},
    {25071.0, -60.8, 24.0, 290.0, 9.774436, 2.0},
    {25336.0, -60.6, 23.0, 275.0, 10.803324, 2.0},
    {25391.0, -60.5, 22.8, 277.0, 11.317768000000001, 2.0},
    {25557.0, -60.7, 22.2, 283.0, 11.832212, 2.0},
    {25613.0, -60.7, 22.0, 285.0, 12.346656, 2.0},
    {25874.0, -60.1, 21.1, 281.0, 7.71666, 2.0},
    {25904.0, -60.0, 21.0, 280.0, 7.202216, 2.0},
    {26210.0, -58.9, 20.0, 290.0, 9.774436, 3.0},
    {26337.0, -58.7, 19.6, 292.0, 9.774436, 3.0},
    {26532.0, -58.3, 19.0, 295.0, 10.28888, 2.0},
    {26665.0, -58.1, 18.6, 287.0, 9.774436, 2.0},
    {26872.0, -57.1, 18.0, 275.0, 9.259992, 2.0},
    {27014.0, -56.5, 17.6, 275.0, 11.317768000000001, 2.0},
    {27233.0, -57.1, 17.0, 275.0, 13.889988, 3.0},
    {27421.0, -57.7, 16.5, 265.0, 14.918876000000001, 3.0},
    {27615.0, -57.9, 16.0, 255.0, 15.947764000000001, 3.0},
    {27979.0, -58.3, 15.1, 255.0, 16.462208, 3.0},
    {28021.0, -58.2, 15.0, 255.0, 16.462208, 3.0},
    {28455.0, -57.4, 14.0, 250.0, 14.918876000000001, 3.0},
    {28500.0, -57.3, 13.9, 251.0, 15.43332, 3.0},
    {28922.0, -57.7, 13.0, 265.0, 18.519984, 3.0},
    {29220.0, -57.5, 12.4, 274.0, 21.092204, 3.0},
    {29322.0, -57.5, 12.2, 277.0, 22.121092, 3.0},
    {29374.0, -57.5, 12.1, 278.0, 22.635536000000002, 3.0},
    {29427.0, -57.3, 12.0, 280.0, 23.14998, 3.0},
    {29981.0, -54.9, 11.0, 280.0, 20.57776, 3.0},
    {30399.0, -53.1, 10.3, 270.0, 20.063316, 3.0},
    {30590.0, -52.1, 10.0, 265.0, 20.063316, 2.0},
    {31062.0, -50.7, 9.3, 268.0, 22.635536000000002, 3.0},
    {31274.0, -51.2, 9.0, 270.0, 23.664424, 3.0},
    {31958.0, -52.9, 8.1, 274.0, 23.14998, 3.0},
    {32038.0, -52.7, 8.0, 275.0, 23.14998, 3.0},
    {32634.0, -49.1, 7.3, 272.0, 24.693312, 3.0},
    {32910.0, -48.3, 7.0, 270.0, 25.207756, 3.0},
    {33929.0, -46.7, 6.0, 265.0, 35.496636, 3.0}};

void SimEnvironmental::setAltitudeMeters(double altitude_meters) {
  altitude_meters_ = altitude_meters;

  if (altitude_meters_ < 0.0) {
    altitude_meters_ = 5.0;
  } else if (altitude_meters_ > 33929.0) {
    altitude_meters_ = 33900.0;
  }

  // Find the closest altitude in the table
  size_t i = 0;
  while (i < K_ENVIRONMENTAL_DATA.size() &&
         K_ENVIRONMENTAL_DATA.at(i).altitude_meters < altitude_meters_) {
    i++;
  }

  if (i == 0) {
    i = 1;
  } else if (i == K_ENVIRONMENTAL_DATA.size()) {
    i = K_ENVIRONMENTAL_DATA.size() - 1;
  }

  // Interpolate the environmental data
  const auto &data1 = K_ENVIRONMENTAL_DATA.at(i - 1);
  const auto &data2 = K_ENVIRONMENTAL_DATA.at(i);

  double fraction = (altitude_meters_ - data1.altitude_meters) /
                    (data2.altitude_meters - data1.altitude_meters);

  env_data_.temperature_celsius =
      data1.temperature_celsius +
      fraction * (data2.temperature_celsius - data1.temperature_celsius);
  env_data_.pressure_millibars =
      data1.pressure_millibars +
      fraction * (data2.pressure_millibars - data1.pressure_millibars);
  env_data_.wind_speed_mps =
      data1.wind_speed_mps +
      fraction * (data2.wind_speed_mps - data1.wind_speed_mps);
  env_data_.wind_direction_degrees =
      data1.wind_direction_degrees +
      fraction * (data2.wind_direction_degrees - data1.wind_direction_degrees);
  env_data_.relative_humidity_percent =
      data1.relative_humidity_percent +
      fraction *
          (data2.relative_humidity_percent - data1.relative_humidity_percent);
}

double SimEnvironmental::getWindSpeedMPS() const {
  return env_data_.wind_speed_mps;
}

double SimEnvironmental::getWindDirectionDegrees() const {
  return env_data_.wind_direction_degrees;
}

double SimEnvironmental::getTemperatureCelsius() const {
  return env_data_.temperature_celsius;
}

double SimEnvironmental::getPressureMillibars() const {
  return env_data_.pressure_millibars;
}

double SimEnvironmental::getRelativeHumidityPercent() const {
  return env_data_.relative_humidity_percent;
}

} // namespace gfs_sim
